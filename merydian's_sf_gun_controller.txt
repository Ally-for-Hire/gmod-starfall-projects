--@name Merydian's SF Gun Controller
--@author Ally for Hire / Merydian9
--@include allylib/simple_server-side_wire_helper.txt
--@include allylib/curve-fitting_ballistics_algorithm.txt
--@server

local curtime = timer.curtime
require("allylib/simple_server-side_wire_helper.txt")
require("allylib/curve-fitting_ballistics_algorithm.txt")

INTERVAL   = 0.05
GZ         = 600
LOAD_DIST  = 10000
LOAD_PITCH = nil

NextThink  = 0
Unlocked   = false
LastGun    = nil
LastTargetVel  = Vector()
LastTargetTime = 0
TargetAccel    = Vector()
LastReady      = false

local function updateTargetAccel(tvel, now)
    if LastTargetTime <= 0 then
        LastTargetVel = tvel
        LastTargetTime = now
        TargetAccel = Vector()
        return TargetAccel
    end

    local dt = now - LastTargetTime
    if dt <= 0 then
        TargetAccel = Vector()
    else
        TargetAccel = (tvel - LastTargetVel) / dt
    end

    LastTargetVel = tvel
    LastTargetTime = now

    return TargetAccel
end

local function getBasePos(hit, tpos)
    if tpos:getLength() > 0 then
        return tpos
    end
    return hit
end

local function getLoadAimPos(gun, base, targetPos, loadAng)
    if not gun or not gun:isValid() then return nil end
    if not base or not base:isValid() then return nil end

    local origin = gun:getMassCenterW() or gun:getPos()
    local baseAng = base:getAngles()
    local toTarget = targetPos - origin
    local yaw = toTarget:getAngle().y
    local ang = Angle(baseAng.p - loadAng.p, yaw, 0)
    return origin + ang:getForward() * LOAD_DIST
end

local function getBallisticAimPos(gun, base, basePos, tvel, tacc, tvelLen, taccLen)
    local gpos = gun:getMassCenterW() or gun:getPos()
    local dist = gpos:getDistance(basePos)
    local bvel  = base:getVelocity()
    local baseToGun = basePos - gpos
    local tta = 0

    if tvelLen == 0 and taccLen == 0 then 
        tta = ballisticTime(dist) or 0
    else
        local low = 0
        local high = 6
        tta = (low + high) / 2

        while high - low > 0.05 and ballisticDistance do
            tta = (low + high) / 2

            local ttaSq = tta * tta
            local drop = Vector(0, 0, 0.5 * GZ * ttaSq)
            local accel = tacc * (0.5 * ttaSq)
            local tlen = (baseToGun + tvel * tta + accel + drop):getLength()
            local slen = ballisticDistance(tta)
            local diff = slen - tlen

            if diff < 0 then
                low = tta
            else
                high = tta
            end

            tta = high
        end
    end

    local drag = -bvel * tta
    local ttaSq = tta * tta
    local drop = Vector(0, 0, 0.5 * GZ * ttaSq)
    local accel = tacc * (0.5 * ttaSq)
    local aimPos = basePos + tvel * tta + accel + drag + drop
    return aimPos, tta
end

local function main()
    local now = curtime()
    if now < NextThink then return end
    NextThink = now + INTERVAL

    local gun    = Inputs.Gun:get()    or I.Gun
    local base   = Inputs.Base:get()
    local hit    = Inputs.HitPos:get() or Vector()
    local tpos   = Inputs.TargetPos:get() or Vector()
    local tvel   = Inputs.TargetVel:get() or Vector()
    local manual = (Inputs.M2:get()    or 0) ~= 0
    local loadEnabled = LOAD_PITCH ~= nil
    local loadAng = nil
    if loadEnabled then
        loadAng = Angle(LOAD_PITCH, 0, 0)
    end
    local gunValid = gun and gun:isValid()
    local baseValid = base and base:isValid()
    local ready = false
    if gunValid and gun.acfReady then
        ready = gun:acfReady()
    end
    if ready ~= LastReady then
        LastReady = ready
    end

    -- keep C-FBA in sync
    if gunValid and gun ~= LastGun and CFBA_SetGun then
        CFBA_SetGun(gun)
        LastGun = gun
    end

    local tacc = updateTargetAccel(tvel, now)
    local basePos = getBasePos(hit, tpos)
    local aimPos = basePos
    local tta    = 0

    local activeControl =
        Unlocked and not manual and
        gunValid and
        baseValid

    local loadActive = loadEnabled and Unlocked and not manual and not LastReady
    if loadActive then
        local loadPos = getLoadAimPos(gun, base, basePos, loadAng)
        if loadPos then
            aimPos = loadPos
        end
        tta = 0
    elseif activeControl then
        local tvelLen = tvel:getLength()
        local taccLen = tacc:getLength()
        aimPos, tta = getBallisticAimPos(gun, base, basePos, tvel, tacc, tvelLen, taccLen)
    else
        aimPos = basePos
        tta    = 0
    end

    Outputs.TurretActive:update((Unlocked or loadActive) and 1 or 0)
    Outputs.HAimPos:update(aimPos)
    Outputs.VAimPos:update(aimPos)
    Outputs.TTA:update(tta)
    Outputs.Elevation:update(0)
end

updateInputs("Lock:NORMAL Active:NORMAL M2:NORMAL Gun:ENTITY Base:ENTITY HitPos:VECTOR TargetPos:VECTOR TargetVel:VECTOR")
updateOutputs("TurretActive:NORMAL HAimPos:VECTOR VAimPos:VECTOR TTA:NORMAL Elevation:NORMAL")

Inputs.Lock:addTrigger(function(v)
    if v == 0 then return end
    Unlocked = not Unlocked
end)

Inputs.Active:addTrigger(function(v)
    Unlocked = false
end)

hook.add("think", "SF_MGC", main)
