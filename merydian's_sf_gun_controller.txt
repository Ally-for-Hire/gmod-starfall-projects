--@name Merydian's SF Gun Controller
--@author Ally for Hire / Merydian9
--@include allylib/simple_server-side_wire_helper.txt
--@include allylib/curve-fitting_ballistics_algorithm.txt
--@server

local curtime = timer.curtime
require("allylib/simple_server-side_wire_helper.txt")
require("allylib/curve-fitting_ballistics_algorithm.txt")

INTERVAL   = 0.05
GZ         = 600

NextThink  = 0
Unlocked   = false
LastGun    = nil
LastTargetVel  = Vector()
LastTargetTime = 0
TargetAccel    = Vector()

local function updateTargetAccel(tvel, now)
    if LastTargetTime <= 0 then
        LastTargetVel = tvel
        LastTargetTime = now
        TargetAccel = Vector()
        return TargetAccel
    end

    local dt = now - LastTargetTime
    if dt <= 0 then
        TargetAccel = Vector()
    else
        TargetAccel = (tvel - LastTargetVel) / dt
    end

    LastTargetVel = tvel
    LastTargetTime = now

    return TargetAccel
end

local function main()
    local now = curtime()
    if now < NextThink then return end
    NextThink = now + INTERVAL

    local gun    = Inputs.Gun:get()    or I.Gun
    local base   = Inputs.Base:get()
    local hit    = Inputs.HitPos:get() or Vector()
    local tpos   = Inputs.TargetPos:get() or Vector()
    local tvel   = Inputs.TargetVel:get() or Vector()
    local manual = (Inputs.M2:get()    or 0) ~= 0

    -- keep C-FBA in sync
    if gun and gun:isValid() and gun ~= LastGun and CFBA_SetGun then
        CFBA_SetGun(gun)
        LastGun = gun
    end

    local tacc = updateTargetAccel(tvel, now)
    local tvelLen = tvel:getLength()
    local taccLen = tacc:getLength()
    local basePos = hit
    if tpos:getLength() > 0 then
        basePos = tpos
    end
    local aimPos = basePos
    local tta    = 0

    local activeControl =
        Unlocked and not manual and
        gun and gun:isValid() and
        base and base:isValid()

    if activeControl then
        local dist = gun:getMassCenterW():getDistance(basePos)
        local bvel  = base:getVelocity()
        local gpos  = gun:getMassCenterW() or gun:getPos()

        if tvelLen == 0 and taccLen == 0 then 
            tta = ballisticTime(dist) or 0
        else
            local low = 0
            local high = 6
            tta = (low + high) / 2

            while high - low > 0.05 and ballisticDistance do
                tta = (low + high) / 2

                local ttaSq = tta * tta
                local drop = Vector(0, 0, 0.5 * GZ * ttaSq)
                local accel = tacc * (0.5 * ttaSq)
                local tlen = (basePos - gpos + tvel * tta + accel + drop):getLength()
                local slen = ballisticDistance(tta)
                local diff = slen - tlen

                if diff < 0 then
                    low = tta
                else
                    high = tta
                end

                tta = high
            end
        end

        local drag = -bvel * tta
        local ttaSq = tta * tta
        local drop = Vector(0, 0, 0.5 * GZ * ttaSq)
        local accel = tacc * (0.5 * ttaSq)
        aimPos = basePos + tvel * tta + accel + drag + drop
    else
        aimPos = basePos
        tta    = 0
    end

    Outputs.TurretActive:update(Unlocked and 1 or 0)
    Outputs.HAimPos:update(aimPos)
    Outputs.VAimPos:update(aimPos)
    Outputs.TTA:update(tta)
    Outputs.Elevation:update(0)
end

updateInputs("Lock:NORMAL Active:NORMAL M2:NORMAL Gun:ENTITY Base:ENTITY HitPos:VECTOR TargetPos:VECTOR TargetVel:VECTOR")
updateOutputs("TurretActive:NORMAL HAimPos:VECTOR VAimPos:VECTOR TTA:NORMAL Elevation:NORMAL")

Inputs.Lock:addTrigger(function(v)
    if v == 0 then return end
    Unlocked = not Unlocked
end)

Inputs.Active:addTrigger(function(v)
    Unlocked = false
end)

hook.add("think", "SF_MGC", main)
